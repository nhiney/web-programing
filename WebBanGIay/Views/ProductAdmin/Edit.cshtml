@model WebBanGIay.Models.SANPHAM
@{
    ViewBag.Title = "Sửa sản phẩm";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container py-4" style="color:#d8e5f7; max-width: 700px;">
    <div class="card bg-dark border-secondary shadow">
        <div class="card-header border-secondary bg-warning text-dark">
            <h4 class="mb-0 fw-bold"><i class="bi bi-pencil"></i> Sửa sản phẩm</h4>
        </div>
        <div class="card-body">
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger">@TempData["Error"]</div>
            }

            <form method="post" action="@Url.Action("Edit")" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" name="MASANPHAM" value="@Model.MASANPHAM.Trim()" />

                <div class="mb-3">
                    <label class="form-label">Mã sản phẩm</label>
                    <input type="text" class="form-control bg-secondary text-light border-0" value="@Model.MASANPHAM.Trim()" disabled />
                </div>

                <div class="mb-3">
                    <label class="form-label">Tên sản phẩm</label>
                    <input type="text" name="TENSANPHAM" class="form-control bg-dark text-light border-secondary" value="@Model.TENSANPHAM" required />
                    @Html.ValidationMessage("TENSANPHAM", new { @class = "text-danger small" })
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Giá (VNĐ)</label>
                        <input type="number" name="GIA" class="form-control bg-dark text-light border-secondary" value="@Model.GIA" min="0" required />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Số lượng tồn</label>
                        <input type="number" name="SOLUONGTON" class="form-control bg-dark text-light border-secondary" value="@Model.SOLUONGTON" min="0" />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Mô tả</label>
                    <textarea name="MOTA" class="form-control bg-dark text-light border-secondary" rows="3">@Model.MOTA</textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Hình ảnh hiện tại</label>
                    @if (!string.IsNullOrEmpty(Model.HINHANH))
                    {
                        <div><img src="@Model.HINHANH" style="max-width:150px;max-height:150px;" class="rounded border" onerror="this.onerror=null; this.src='/source/images/shoes.png';" /></div>
                    }
                    else
                    {
                        <div class="text-muted">Chưa có hình</div>
                    }
                </div>

                <div class="mb-4">
                    <label class="form-label">Đổi hình ảnh mới</label>
                    <input type="file" name="imageFile" class="form-control bg-dark text-light border-secondary" accept="image/*" />
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-warning fw-bold py-2">
                        <i class="bi bi-save"></i> Lưu thay đổi
                    </button>
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">Hủy bỏ</a>
                </div>
            </form>
        </div>
    </div>

    <!-- VARIANTS SECTION -->
    <div class="card bg-dark border-secondary shadow mt-4">
        <div class="card-header border-secondary bg-info text-dark d-flex justify-content-between align-items-center">
            <h4 class="mb-0 fw-bold"><i class="bi bi-grid"></i> Biến thể sản phẩm (Màu sắc)</h4>
            <span class="badge bg-light text-dark" id="variantCount">0 biến thể</span>
        </div>
        <div class="card-body">
            <!-- Add Variant Form -->
            <div class="row g-2 align-items-end mb-4 p-3 border border-secondary rounded bg-secondary bg-opacity-10">
                <div class="col-md-5">
                    <label class="form-label text-light">Màu sắc</label>
                    <input type="text" id="newColor" class="form-control bg-dark text-light border-secondary" placeholder="Ví dụ: Đỏ, Xanh..." />
                </div>
                <div class="col-md-5">
                    <label class="form-label text-light">Giá theo màu</label>
                    <input type="number" id="newPrice" class="form-control bg-dark text-light border-secondary" value="@Model.GIA" min="0" />
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-primary w-100" onclick="addVariant()">
                        <i class="bi bi-plus-lg"></i> Thêm
                    </button>
                </div>
            </div>

            <!-- Variants List -->
            <div class="table-responsive">
                <table class="table table-dark table-hover border-secondary">
                    <thead>
                        <tr>
                            <th>Màu sắc</th>
                            <th>Giá (VNĐ)</th>
                            <th class="text-center" style="width: 100px;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="variantTableBody">
                        <!-- Ajax Content -->
                    </tbody>
                </table>
                <div id="loadingVariants" class="text-center text-muted my-3" style="display:none;">
                    <div class="spinner-border spinner-border-sm text-info" role="status"></div> Đang tải...
                </div>
                <div id="emptyVariants" class="text-center text-muted my-3" style="display:none;">
                    Chưa có biến thể nào.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var productId = '@Model.MASANPHAM.Trim()';

    document.addEventListener("DOMContentLoaded", function() {
        loadVariants();
    });

    function loadVariants() {
        document.getElementById("loadingVariants").style.display = 'block';
        document.getElementById("variantTableBody").innerHTML = '';
        
        fetch('/ProductAdmin/GetVariants?productId=' + productId)
            .then(r => r.json())
            .then(res => {
                document.getElementById("loadingVariants").style.display = 'none';
                if(res.success) {
                    renderVariants(res.data);
                } else {
                    alert("Lỗi tải biến thể");
                }
            })
            .catch(err => {
                console.error(err);
                document.getElementById("loadingVariants").style.display = 'none';
            });
    }

    function renderVariants(list) {
        var tbody = document.getElementById("variantTableBody");
        document.getElementById("variantCount").innerText = list.length + " biến thể";
        
        if (list.length === 0) {
            document.getElementById("emptyVariants").style.display = 'block';
            return;
        }
        
        document.getElementById("emptyVariants").style.display = 'none';

        list.forEach(v => {
            var tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="badge bg-secondary fs-6">${v.MAUSAC}</span></td>
                <td class="text-warning fw-bold">${new Intl.NumberFormat('vi-VN').format(v.GIATHEOMAU)} ₫</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteVariant(${v.ID})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function addVariant() {
        var color = document.getElementById("newColor").value.trim();
        var price = document.getElementById("newPrice").value;

        if (!color) {
            alert("Vui lòng nhập màu sắc!");
            return;
        }

        var formData = new FormData();
        formData.append("productId", productId);
        formData.append("color", color);
        formData.append("price", price);

        fetch('/ProductAdmin/AddVariant', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                document.getElementById("newColor").value = '';
                loadVariants();
            } else {
                alert(res.message || "Lỗi khi thêm");
            }
        })
        .catch(err => alert("Lỗi kết nối"));
    }

    function deleteVariant(id) {
        if (!confirm("Bạn có chắc muốn xóa biến thể này?")) return;

        var formData = new FormData();
        formData.append("id", id);

        fetch('/ProductAdmin/DeleteVariant', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                loadVariants();
            } else {
                alert(res.message || "Lỗi khi xóa");
            }
        })
        .catch(err => alert("Lỗi kết nối"));
    }
</script>
