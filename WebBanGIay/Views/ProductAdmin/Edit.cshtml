@model WebBanGIay.Models.SANPHAM
@{
    ViewBag.Title = "Sửa sản phẩm";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    .page-container {
        padding: 24px;
        color: var(--text-main);
    }
</style>

<div class="page-container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <form method="post" action="@Url.Action("Edit")" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" name="MASANPHAM" value="@Model.MASANPHAM.Trim()" />

                <!-- Product Info Card -->
                <div class="card card-premium mb-4">
                    <div class="card-header-premium d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-pencil-square text-warning"></i> Sửa thông tin sản phẩm</h5>
                        <a href="@Url.Action("Create", "ImportAdmin", new { productId = Model.MASANPHAM.Trim() })" class="btn btn-sm btn-outline-primary border-primary">
                            <i class="bi bi-box-arrow-in-down me-1"></i> Nhập hàng vào kho
                        </a>
                    </div>
                    <div class="card-body p-4">
                        @if (TempData["Success"] != null)
                        {
                            <div class="alert alert-success mb-4 border-0 bg-success bg-opacity-10 text-success fw-bold">
                                <i class="bi bi-check-circle me-2"></i> @TempData["Success"]
                            </div>
                        }

                        @if (Model.SOLUONGTON == 0 || Model.SOLUONGTON == null)
                        {
                             <div class="alert alert-info mb-4 border-0 bg-info bg-opacity-10 text-info">
                                <i class="bi bi-info-circle-fill me-2"></i> 
                                <strong>Lưu ý chuyên nghiệp:</strong> Sản phẩm này chưa có tồn kho. Hãy <strong>thêm biến thể (Màu sắc)</strong> và sau đó click vào <strong>"Nhập hàng vào kho"</strong> để cập nhật số lượng nhập thực tế.
                            </div>
                        }

                        <div class="mb-4">
                            <label class="form-label-premium">Mã sản phẩm</label>
                            <input type="text" class="form-control form-control-premium text-muted" value="@Model.MASANPHAM.Trim()" disabled />
                        </div>

                        <div class="mb-4">
                            <label class="form-label-premium">Tên sản phẩm <span class="text-danger">*</span></label>
                            <input type="text" name="TENSANPHAM" class="form-control form-control-premium" value="@Model.TENSANPHAM" required placeholder="Nhập tên sản phẩm..." />
                            @Html.ValidationMessage("TENSANPHAM", new { @class = "text-danger small mt-1 fw-bold" })
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label-premium">Giá bán (VNĐ) <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-transparent border-secondary text-muted" style="border-right:0;"><i class="bi bi-cash"></i></span>
                                    <input type="number" name="GIA" class="form-control form-control-premium" value="@Model.GIA" min="0" required style="border-left:0;" />
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <label class="form-label-premium">Thương hiệu / Nhà cung cấp <span class="text-danger">*</span></label>
                                <select name="MANHACUNGCAP" class="form-select form-select-premium" required>
                                    <option value="">-- Chọn thương hiệu --</option>
                                    @foreach (var ncc in ViewBag.NHACUNGCAP as List<WebBanGIay.Models.NHACUNGCAP>)
                                    {
                                        <option value="@ncc.MANHACUNGCAP.Trim()" @(Model.MANHACUNGCAP != null && Model.MANHACUNGCAP.Trim() == ncc.MANHACUNGCAP.Trim() ? "selected" : "")>
                                            @ncc.TENNHACUNGCAP
                                        </option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label-premium">Số lượng tồn</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-transparent border-secondary text-muted" style="border-right:0;"><i class="bi bi-box-seam"></i></span>
                                    <input type="number" name="SOLUONGTON" class="form-control form-control-premium bg-light" value="@Model.SOLUONGTON" readonly style="border-left:0;" />
                                </div>
                                <div class="form-text text-muted small fst-italic"><i class="bi bi-info-circle"></i> Số lượng được quản lý bởi phiếu nhập</div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label-premium">Mô tả sản phẩm</label>
                            <textarea name="MOTA" class="form-control form-control-premium" rows="5" placeholder="Nhập mô tả chi tiết...">@Model.MOTA</textarea>
                        </div>

                        <div class="row align-items-center p-3 rounded border border-secondary border-opacity-25 bg-secondary bg-opacity-10">
                            <div class="col-md-4 text-center mb-3 mb-md-0">
                                <label class="form-label-premium d-block mb-2">Hình ảnh hiện tại</label>
                                @if (!string.IsNullOrEmpty(Model.HINHANH))
                                {
                                    <div class="p-1 border rounded bg-white d-inline-block shadow-sm">
                                        <img src="@Model.HINHANH" style="width:100px; height:100px; object-fit:contain;" onerror="this.onerror=null; this.src='/source/images/shoes.png';" />
                                    </div>
                                }
                                else
                                {
                                    <div class="text-muted small fst-italic py-4">Chưa có hình ảnh</div>
                                }
                            </div>
                            <div class="col-md-8">
                                <label class="form-label-premium">Cập nhật hình ảnh (nếu cần)</label>
                                <input type="file" name="imageFile" class="form-control form-control-premium" accept="image/*" />
                                <div class="form-text text-muted small mt-2"><i class="bi bi-info-circle me-1"></i> Hỗ trợ định dạng .jpg, .png, .jpeg</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Variants Card -->
                <div class="card card-premium mb-4">
                    <div class="card-header-premium">
                        <h5><i class="bi bi-palette text-info"></i> Biến thể (Màu sắc)</h5>
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25" id="variantCount">Loading...</span>
                    </div>
                    <div class="card-body p-4">
                        
                        <!-- Add Variant Inline Form -->
                        <div class="d-flex flex-wrap flex-md-nowrap gap-3 mb-4 p-3 rounded border border-secondary border-opacity-25" style="background: var(--bg-hover);">
                            <div class="flex-grow-1">
                                <label class="form-label-premium mb-1">Màu sắc</label>
                                <input type="text" id="newColor" class="form-control form-control-premium" placeholder="Ví dụ: Đỏ, Xanh..." />
                            </div>
                            <div style="width: 100%; max-width: 200px;">
                                <label class="form-label-premium mb-1">Giá theo màu</label>
                                <input type="number" id="newPrice" class="form-control form-control-premium" value="@Model.GIA" min="0" />
                            </div>
                            <div class="d-flex align-items-end">
                                <button type="button" class="btn btn-primary btn-premium" onclick="addVariant()">
                                    <i class="bi bi-plus-lg"></i> Thêm mới
                                </button>
                            </div>
                        </div>

                        <!-- Variants List -->
                        <div id="variantsList" class="border rounded overflow-hidden">
                            <!-- JS will populate -->
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex gap-3 justify-content-end mb-5">
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary btn-premium">Hủy bỏ</a>
                    <button type="submit" class="btn btn-warning btn-premium">
                        <i class="bi bi-check-lg"></i> Lưu thay đổi
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- Modal Manage Sizes -->
<div class="modal fade" id="modalScanSize" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Quản lý Kho & Size - <span id="modalVariantColor" class="fw-bold text-warning"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="currentVariantId" />
                
                <!-- Add Size Form -->
                <div class="row g-3 align-items-end mb-4 p-3 bg-light rounded border">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Kích thước (Size)</label>
                        <select id="newSize" class="form-select">
                            <option value="">Chọn Size</option>
                            @for(int i=35; i<=45; i++){ <option value="@i">@i</option> }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Số lượng tồn</label>
                        <input type="number" id="newQty" class="form-control" value="10" min="0" />
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-success w-100" onclick="saveSize()">
                            <i class="bi bi-plus-circle"></i> Lưu kho
                        </button>
                    </div>
                </div>

                <!-- List Current Sizes -->
                <div id="sizeListContainer">
                    <!-- JS renders table here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var currentProductId = '@Model.MASANPHAM.Trim()';

    document.addEventListener('DOMContentLoaded', function() {
        loadVariants();
    });

    function loadVariants() {
        fetch('@Url.Action("GetVariants", "ProductAdmin")?productId=' + currentProductId)
        .then(res => res.json())
        .then(res => {
            if(res.success) {
                renderVariants(res.data);
            }
        });
    }

    function renderVariants(data) {
        var html = '';
        if(!data || data.length === 0) {
            html = '<div class="text-center text-muted py-5 bg-opacity-10 bg-secondary"><div><i class="bi bi-box-seam fs-1 mb-2 d-block"></i>Chưa có biến thể màu sắc nào</div></div>';
            document.getElementById('variantCount').innerText = '0 biến thể';
        } else {
            document.getElementById('variantCount').innerText = data.length + ' biến thể';
            
            html = '<div class="table-responsive"><table class="table mb-0" style="color:var(--text-main)"><thead><tr class="bg-secondary bg-opacity-10"><th class="ps-4">Màu sắc</th><th>Giá riêng</th><th class="text-center">Kho hàng</th><th class="text-end pe-4">Hành động</th></tr></thead><tbody>';
            
            data.forEach(item => {
                html += `
                    <tr>
                        <td class="align-middle ps-4">
                            <span class="badge bg-secondary text-white px-3 py-2 rounded-pill border border-secondary border-opacity-50">${item.MAUSAC}</span>
                        </td>
                        <td class="align-middle text-success fw-bold">
                            ${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.GIATHEOMAU)}
                        </td>
                         <td class="align-middle text-center">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="openSizeModal(${item.ID}, '${item.MAUSAC}')">
                                <i class="bi bi-layers-half"></i> Quản lý Size/Kho
                            </button>
                        </td>
                        <td class="align-middle text-end pe-4">
                            <button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="deleteVariant(${item.ID})" title="Xóa">
                                <i class="bi bi-trash fs-5"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
        }
        document.getElementById('variantsList').innerHTML = html;
    }

    function addVariant() {
        var color = document.getElementById('newColor').value;
        var price = document.getElementById('newPrice').value;

        if(!color) { alert('Vui lòng nhập màu sắc'); return; }

        var formData = new FormData();
        formData.append('productId', currentProductId);
        formData.append('color', color);
        formData.append('price', price);

        fetch('@Url.Action("AddVariant", "ProductAdmin")', {
            method: 'POST',
            body: formData
        }).then(res => res.json())
        .then(data => {
            if(data.success) {
                document.getElementById('newColor').value = '';
                loadVariants();
            } else {
                alert(data.message);
            }
        });
    }

    function deleteVariant(id) {
        if(!confirm('Xóa biến thể này sẽ xóa tất cả tồn kho liên quan?')) return;
        
        fetch('@Url.Action("DeleteVariant", "ProductAdmin")', {
            method: 'POST',
            body: new URLSearchParams({ 'id': id })
        }).then(res => res.json())
        .then(data => {
            if(data.success) {
                loadVariants();
            } else {
                alert(data.message);
            }
        });
    }

    // ============ SIZE & STOCK MANAGE Start ============
    var sizeModal = null;
    
    function openSizeModal(variantId, colorName) {
         document.getElementById('currentVariantId').value = variantId;
         document.getElementById('modalVariantColor').innerText = colorName;
         
         if(!sizeModal) {
             sizeModal = new bootstrap.Modal(document.getElementById('modalScanSize'));
         }
         loadSizes(variantId);
         sizeModal.show();
    }

    function loadSizes(variantId) {
        fetch('@Url.Action("GetSizes", "ProductAdmin")?variantId=' + variantId)
        .then(res => res.json())
        .then(res => {
            if(res.success) {
                renderSizeTable(res.data);
            }
        });
    }

    function renderSizeTable(data) {
        var html = '<table class="table table-bordered table-striped text-center align-middle"><thead><tr><th>Size</th><th>Số lượng tồn</th><th>Hành động</th></tr></thead><tbody>';
        
        if(!data || data.length === 0) {
            html += '<tr><td colspan="3" class="text-muted">Chưa có size nào</td></tr>';
        } else {
            var totalStock = 0;
            data.forEach(item => {
                totalStock += item.SOLUONG;
                html += `
                    <tr>
                        <td class="fw-bold text-primary" style="font-size:1.2rem;">${item.SIZE}</td>
                        <td class="fw-bold">${item.SOLUONG}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteSize(${item.ID})"><i class="bi bi-x-lg"></i> Xóa</button>
                        </td>
                    </tr>
                `;
            });
            html += `<tr class="table-info"><td class="fw-bold">Tổng cộng</td><td colspan="2" class="fw-bold text-start ps-4">${totalStock} sản phẩm</td></tr>`;
        }
        
        html += '</tbody></table>';
        document.getElementById('sizeListContainer').innerHTML = html;
    }

    function saveSize() {
        var variantId = document.getElementById('currentVariantId').value;
        var size = document.getElementById('newSize').value;
        var qty = document.getElementById('newQty').value;

        if(!size || !qty) { alert('Vui lòng chọn Size và nhập Số lượng'); return; }

        var formData = new FormData();
        formData.append('variantId', variantId);
        formData.append('size', size);
        formData.append('quantity', qty);

        fetch('@Url.Action("SaveSize", "ProductAdmin")', {
            method: 'POST',
            body: formData
        }).then(res => res.json())
        .then(data => {
            if(data.success) {
                loadSizes(variantId); // Reload table
                // Optionally clear inputs
            } else {
                alert(data.message);
            }
        });
    }

    function deleteSize(id) {
        if(!confirm('Xóa size này kho?')) return;
         var variantId = document.getElementById('currentVariantId').value;

         fetch('@Url.Action("DeleteSize", "ProductAdmin")', {
            method: 'POST',
            body: new URLSearchParams({ 'id': id })
        }).then(res => res.json())
        .then(data => {
            if(data.success) {
                loadSizes(variantId);
            } else {
                alert(data.message);
            }
        });
    }
    // ============ SIZE & STOCK MANAGE End ============
</script>
