@model IEnumerable<WebBanGIay.Models.SANPHAM>
@{
    ViewBag.Title = "Product Management";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var query = ViewBag.Query as string;
    var currentPage = ViewBag.Page ?? 1; // Rename to avoid conflict if any, though local var is fine
    var totalPages = ViewBag.TotalPages ?? 1;
}

<style>
    .page-container {
        color: var(--text-main);
        padding: 24px;
        font-family: "Inter", sans-serif;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .page-title {
        font-size: 26px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
    }

    /* Search & Filter Styles */
    .filter-bar {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .search-input {
        background: var(--bg-body);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        border-radius: 8px;
        padding: 10px 16px;
        width: 260px;
        transition: 0.2s;
    }
    .search-input:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px var(--bg-active);
        outline: none;
    }

    .btn-search {
        padding: 10px 16px;
        border-radius: 8px;
        background: var(--accent-color);
        color: #fff;
        border: none;
        cursor: pointer;
        transition: 0.2s;
    }
    .btn-search:hover { filter: brightness(1.1); }

    .btn-reset {
        padding: 10px 16px;
        border-radius: 8px;
        background: var(--bg-card);
        color: var(--text-muted);
        border: 1px solid var(--border-color);
        text-decoration: none;
        transition: 0.2s;
    }
    .btn-reset:hover { background: var(--bg-hover); color: var(--text-main); }

    .btn-create {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        padding: 10px 20px;
        font-weight: 600;
        border-radius: 8px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: 0.2s;
    }
    .btn-create:hover {
        background: var(--bg-hover);
        color: var(--accent-color);
        border-color: var(--accent-color);
    }

    /* Table Styles */
    .table-responsive-custom {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
        box-shadow: var(--shadow-card);
    }

    .table-custom {
        width: 100%;
        border-collapse: collapse;
    }

    .table-custom thead {
        background: var(--bg-hover);
    }

    .table-custom th {
        padding: 16px 20px;
        text-align: left;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-label);
        border-bottom: 2px solid var(--border-color);
    }

    .table-custom td {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-main);
        vertical-align: middle;
    }

    .table-custom tbody tr {
        background: var(--bg-card);
        transition: background 0.2s;
    }
    .table-custom tbody tr:hover {
        background: var(--bg-hover);
    }

    /* Product Specifics */
    .product-img {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid var(--border-color);
        background: var(--bg-body);
    }

    .stock-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
    }
    .stock-ok { background: rgba(28, 200, 138, 0.15); color: #1cc88a; }
    .stock-low { background: rgba(246, 194, 62, 0.15); color: #f6c23e; }
    .stock-out { background: rgba(231, 74, 59, 0.15); color: #e74a3b; }

    .price-text {
        font-weight: 600;
        color: var(--accent-color);
    }

    /* Actions */
    .action-btn {
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: var(--bg-body);
        border: 1px solid var(--border-color);
        color: var(--text-muted);
        margin-right: 4px;
        transition: 0.2s;
        text-decoration: none;
    }
    .action-btn:hover {
        background: var(--accent-color);
        color: #fff;
        border-color: var(--accent-color);
        transform: translateY(-2px);
    }

    /* Pagination */
    .pagination-custom {
        display: flex;
        justify-content: center;
        gap: 6px;
        margin-top: 24px;
    }
    .page-num {
        padding: 8px 14px;
        border-radius: 6px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        text-decoration: none;
        transition: 0.2s;
    }
    .page-num:hover:not(.disabled) {
        border-color: var(--accent-color);
        color: var(--accent-color);
    }
    .page-num.active {
        background: var(--accent-color);
        color: #fff;
        border-color: var(--accent-color);
    }
    .page-num.disabled {
        opacity: 0.5;
        cursor: default;
    }
</style>

<div class="page-container container-fluid">
    
    <!-- HEADER -->
    <div class="page-header">
        <h2 class="page-title"><i class="bi bi-box"></i> Quản lý sản phẩm</h2>
        
        <div class="filter-bar">
            <!-- Search Form -->
            <form method="get" action="@Url.Action("Index", "ProductAdmin")" style="display:flex; gap:8px;">
                <input type="text" name="q" class="search-input" placeholder="Tìm kiếm sản phẩm..." value="@query" />
                <button type="submit" class="btn-search"><i class="bi bi-search"></i></button>
            </form>
            
            <a href="@Url.Action("Index", "ProductAdmin")" class="btn-reset" title="Đặt lại">
                <i class="bi bi-arrow-counterclockwise"></i>
            </a>

            <a href="@Url.Action("Create", "ProductAdmin")" class="btn-create">
                <i class="bi bi-plus-lg"></i> Thêm sản phẩm
            </a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success d-flex align-items-center mb-4" role="alert" style="background: rgba(28, 200, 138, 0.15); border: 1px solid rgba(28, 200, 138, 0.3); color: #1cc88a;">
            <i class="bi bi-check-circle-fill me-2"></i> @TempData["Success"]
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger d-flex align-items-center mb-4" role="alert" style="background: rgba(231, 74, 59, 0.15); border: 1px solid rgba(231, 74, 59, 0.3); color: #e74a3b;">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["Error"]
        </div>
    }

    <!-- TABLE -->
    <div class="table-responsive-custom">
        <table class="table-custom">
            <thead>
                <tr>
                    <th style="width: 80px;">Hình ảnh</th>
                    <th>Tên sản phẩm</th>
                    <th>Giá</th>
                    <th>Tồn kho</th>
                    <th class="text-center">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    // Image logic
                    var imgPath = "/source/images/shoes.png";
                    if (!string.IsNullOrEmpty(item.HINHANH))
                    {
                        if (item.HINHANH.StartsWith("/") || item.HINHANH.StartsWith("http")) { imgPath = item.HINHANH; }
                        else if (item.HINHANH.StartsWith("source/")) { imgPath = "/" + item.HINHANH; }
                        else { imgPath = "/source/images/Products/" + item.HINHANH; }
                    }

                    <tr>
                        <td>
                            <img src="@imgPath" class="product-img" 
                                 onerror="this.onerror=null; this.src='/source/images/shoes.png';" 
                                 alt="Product" />
                        </td>
                        <td>
                            <div style="font-weight:600;">@item.TENSANPHAM</div>
                            <div style="font-size:0.85rem; color:var(--text-muted);">Mã: @item.MASANPHAM</div>
                        </td>
                        <td class="price-text">@String.Format("{0:N0}₫", item.GIA)</td>
                        <td>
                            @if (item.SOLUONGTON <= 0)
                            {
                                <span class="stock-badge stock-out">Hết hàng</span>
                            }
                            else if (item.SOLUONGTON < 10)
                            {
                                <span class="stock-badge stock-low">Sắp hết: @item.SOLUONGTON</span>
                            }
                            else
                            {
                                <span class="stock-badge stock-ok">@item.SOLUONGTON</span>
                            }
                        </td>
                        <td class="text-center">
                            <a href="@Url.Action("Create", "ImportAdmin", new { productId = item.MASANPHAM.Trim() })" class="action-btn" title="Nhập hàng" style="color:var(--accent-color); border-color:var(--accent-color);">
                                <i class="bi bi-box-arrow-in-down"></i>
                            </a>
                            <a href="@Url.Action("Edit", "ProductAdmin", new { id = item.MASANPHAM.Trim() })" class="action-btn" title="Sửa">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="@Url.Action("Details", "ProductAdmin", new { id = item.MASANPHAM.Trim() })" class="action-btn" title="Chi tiết">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="@Url.Action("Delete", "ProductAdmin", new { id = item.MASANPHAM.Trim() })" class="action-btn" 
                               onclick="return confirm('Bạn có chắc muốn xóa sản phẩm này?');" title="Xóa">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                }
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="5" class="text-center py-5" style="color:var(--text-muted);">
                            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                            Không tìm thấy sản phẩm nào
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- PAGINATION -->
    @if (totalPages > 1)
    {
        <div class="pagination-custom">
            <a href="@Url.Action("Index", new { q = query, page = currentPage - 1 })" 
               class="page-num @(currentPage <= 1 ? "disabled" : "")">
                <i class="bi bi-chevron-left"></i>
            </a>

            @for (int i = 1; i <= totalPages; i++)
            {
                <a href="@Url.Action("Index", new { q = query, page = i })" 
                   class="page-num @(i == (int)currentPage ? "active" : "")">@i</a>
            }

            <a href="@Url.Action("Index", new { q = query, page = currentPage + 1 })" 
               class="page-num @(currentPage >= totalPages ? "disabled" : "")">
                <i class="bi bi-chevron-right"></i>
            </a>
        </div>
    }
</div>

<script>
    // Prevent click on disabled pagination links
    document.querySelectorAll(".page-num.disabled").forEach(btn => {
        btn.addEventListener("click", e => e.preventDefault());
    });
</script>
