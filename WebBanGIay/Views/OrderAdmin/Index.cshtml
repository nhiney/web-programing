@model IEnumerable<WebBanGIay.Models.HOADON>

@{
    ViewBag.Title = "Quản lý đơn hàng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    /* Use theme variables */
    .page-title {
        color: var(--text-main);
        font-weight: 700;
        margin-bottom: 24px;
    }

    .card-filter {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        box-shadow: var(--shadow-card);
    }

    .form-control-custom, .form-select-custom {
        background: var(--bg-body);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        padding: 10px 14px;
        border-radius: 6px;
    }

    .form-control-custom:focus, .form-select-custom:focus {
        background: var(--bg-body);
        color: var(--text-main);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px var(--bg-active);
    }

    .table-custom {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table-custom thead th {
        background: var(--bg-hover);
        color: var(--text-label);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        padding: 16px;
        border-bottom: 2px solid var(--border-color);
    }

    .table-custom tbody td {
        background: var(--bg-card);
        color: var(--text-main) !important;
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }
    
    /* Ensure all text in table is visible */
    .table-custom tbody td *:not(.status-badge) {
        color: inherit;
    }
    
    .table-custom tbody td .fw-bold,
    .table-custom tbody td div:not(.status-badge) {
        color: var(--text-main) !important;
    }

    .table-custom tbody tr:hover td {
        background: var(--bg-hover);
    }

    /* Status Badges - Keep original colors */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
    }
    .status-pending { background: rgba(246, 194, 62, 0.15); color: #f6c23e !important; border: 1px solid rgba(246, 194, 62, 0.3); }
    .status-shipping { background: rgba(54, 185, 204, 0.15); color: #36b9cc !important; border: 1px solid rgba(54, 185, 204, 0.3); }
    .status-completed { background: rgba(28, 200, 138, 0.15); color: #1cc88a !important; border: 1px solid rgba(28, 200, 138, 0.3); }
    .status-cancelled { background: rgba(231, 74, 59, 0.15); color: #e74a3b !important; border: 1px solid rgba(231, 74, 59, 0.3); }

    /* Status Badges */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
    }
    .status-pending { background: rgba(246, 194, 62, 0.15); color: #f6c23e; border: 1px solid rgba(246, 194, 62, 0.3); }
    .status-shipping { background: rgba(54, 185, 204, 0.15); color: #36b9cc; border: 1px solid rgba(54, 185, 204, 0.3); }
    .status-completed { background: rgba(28, 200, 138, 0.15); color: #1cc88a; border: 1px solid rgba(28, 200, 138, 0.3); }
    .status-cancelled { background: rgba(231, 74, 59, 0.15); color: #e74a3b; border: 1px solid rgba(231, 74, 59, 0.3); }

    /* Action Buttons */
    .btn-icon {
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        color: var(--text-muted);
        background: var(--bg-body);
        border: 1px solid var(--border-color);
        transition: all 0.2s;
        text-decoration: none;
    }
    .btn-icon:hover {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
        transform: translateY(-2px);
    }

    /* Pagination */
    .pagination-container {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 24px;
    }
    .page-btn {
        padding: 8px 16px;
        border-radius: 6px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        text-decoration: none;
        transition: 0.2s;
    }
    .page-btn:hover:not(.disabled) {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }
    .page-btn.active {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }
    .page-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--bg-body);
    }
</style>

<div class="container-fluid p-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title"><i class="bi bi-receipt"></i> Quản lý đơn hàng</h2>
    </div>

    <!-- FILTER & SEARCH -->
    <div class="card-filter p-3 mb-4">
        @using (Html.BeginForm("Index", "OrderAdmin", FormMethod.Get, new { @class = "row g-3 align-items-end" }))
        {
            <div class="col-md-3">
                <label class="form-label text-muted small fw-bold">Tìm kiếm</label>
                <div class="input-group">
                    <span class="input-group-text" style="background:var(--bg-body); border-color:var(--border-color); color:var(--text-muted);"><i class="bi bi-search"></i></span>
                    <input type="text" name="search" class="form-control form-control-custom" placeholder="Mã đơn / Tên khách..." value="@ViewBag.CurrentSearch" />
                </div>
            </div>

            <div class="col-md-3">
                <label class="form-label text-muted small fw-bold">Trạng thái</label>
                @Html.DropDownList("status", ViewBag.StatusList as SelectList, "Tất cả trạng thái", new { @class = "form-select form-select-custom", onchange = "this.form.submit()" })
            </div>

            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100 fw-bold" style="padding: 10px;">
                    Lọc
                </button>
            </div>
        }
    </div>

    <!-- TABLE -->
    <div class="card-filter" style="padding:0; overflow:hidden;">
        <div class="table-responsive">
            <table class="table-custom">
                <thead>
                    <tr>
                        <th>Mã Đơn</th>
                        <th>Khách Hàng</th>
                        <th>Địa Chỉ Giao</th>
                        <th>Ngày Đặt</th>
                        <th>Trạng Thái</th>
                        <th class="text-center">Thao Tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            string badgeClass = "status-pending";
                            if (item.TRANGTHAI == "ĐANG GIAO") { badgeClass = "status-shipping"; }
                            else if (item.TRANGTHAI == "ĐÃ GIAO") { badgeClass = "status-completed"; }
                            else if (item.TRANGTHAI == "ĐÃ HỦY") { badgeClass = "status-cancelled"; }

                            <tr>
                                <td class="fw-bold text-primary">#@item.MAHOADON.Trim()</td>
                                <td>
                                    <div style="color: var(--text-main); font-weight: 600;">
                                        @(string.IsNullOrWhiteSpace(item.TENNGUOINHAN) ? (item.KHACHHANG?.HOTEN?.Trim() ?? "Ẩn danh") : item.TENNGUOINHAN.Trim())
                                    </div>
                                    <div class="small text-muted">
                                        @(string.IsNullOrWhiteSpace(item.DIENTHOAINGIAO) ? (item.KHACHHANG?.SODIENTHOAI?.Trim() ?? "N/A") : item.DIENTHOAINGIAO.Trim())
                                    </div>
                                </td>
                                <td style="max-width: 250px; word-wrap: break-word;">
                                    <div style="color: var(--text-main); font-size: 0.9rem;">
                                        <i class="bi bi-geo-alt text-danger"></i> 
                                        @(string.IsNullOrWhiteSpace(item.DIACHIGIAO) ? (item.KHACHHANG?.DIACHI?.Trim() ?? "Chưa rõ") : item.DIACHIGIAO.Trim())
                                    </div>
                                </td>
                                <td>@item.NGAYLAP.Value.ToString("dd/MM/yyyy HH:mm")</td>
                                <td><span class="status-badge @badgeClass">@item.TRANGTHAI</span></td>
                                <td class="text-center">
                                    <a href="@Url.Action("Details", "OrderAdmin", new { id = item.MAHOADON.Trim() })" class="btn-icon" title="Chi tiết">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="@Url.Action("Edit", "OrderAdmin", new { id = item.MAHOADON.Trim() })" class="btn-icon" title="Cập nhật trạng thái">
                                        <i class="bi bi-pencil"></i>
                                    </a>

                                    @if (item.TRANGTHAI == "CHỜ XỬ LÝ")
                                    {
                                        using (Html.BeginForm("Approve", "OrderAdmin", new { id = item.MAHOADON.Trim() }, FormMethod.Post, new { style = "display:inline;" }))
                                        {
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn-icon text-success" title="Duyệt đơn hàng" onclick="return confirm('Bạn có chắc muốn duyệt đơn hàng này?');">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                        }
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                                Không tìm thấy đơn hàng nào
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- PAGINATION -->
    <div class="pagination-container">
        @if (ViewBag.CurrentPage > 1)
        {
            <a href="@Url.Action("Index", new { page = ViewBag.CurrentPage - 1, search = ViewBag.CurrentSearch, status = ViewBag.CurrentStatus })" class="page-btn">
                <i class="bi bi-chevron-left"></i>
            </a>
        }
        else
        {
            <span class="page-btn disabled"><i class="bi bi-chevron-left"></i></span>
        }

        @for (int i = 1; i <= ViewBag.TotalPages; i++)
        {
            <a href="@Url.Action("Index", new { page = i, search = ViewBag.CurrentSearch, status = ViewBag.CurrentStatus })" 
               class="page-btn @(i == ViewBag.CurrentPage ? "active" : "")">@i</a>
        }

        @if (ViewBag.CurrentPage < ViewBag.TotalPages)
        {
            <a href="@Url.Action("Index", new { page = ViewBag.CurrentPage + 1, search = ViewBag.CurrentSearch, status = ViewBag.CurrentStatus })" class="page-btn">
                <i class="bi bi-chevron-right"></i>
            </a>
        }
        else
        {
            <span class="page-btn disabled"><i class="bi bi-chevron-right"></i></span>
        }
    </div>

</div>
