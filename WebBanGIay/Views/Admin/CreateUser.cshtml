@model WebBanGIay.Models.TAIKHOAN
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewBag.Title = "Tạo tài khoản";

    var khList = ViewBag.KhachHangList as IEnumerable<WebBanGIay.Models.KHACHHANG>;
    var nvList = ViewBag.NhanVienList as IEnumerable<WebBanGIay.Models.NHANVIEN>;

    var roleList = new List<SelectListItem>
    {
        new SelectListItem { Value = "KHÁCH HÀNG", Text = "Khách hàng" },
        new SelectListItem { Value = "NHÂN VIÊN", Text = "Nhân viên" },
        new SelectListItem { Value = "QUẢN TRỊ", Text = "Quản trị" }
    };
}

<style>
    .page-container {
        padding: 24px;
        color: var(--text-main);
    }
</style>

<div class="page-container">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card card-premium shadow-lg"> 
                <div class="card-header-premium">
                    <h5><i class="bi bi-person-plus text-success"></i> Tạo tài khoản mới</h5>
                </div>

                <div class="card-body p-4">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success mb-4 border-0 bg-success bg-opacity-10 text-success fw-bold">
                            <i class="bi bi-check-circle-fill me-2"></i> @TempData["Success"]
                        </div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger mb-4 border-0 bg-danger bg-opacity-10 text-danger fw-bold">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["Error"]
                        </div>
                    }

                    @using (Html.BeginForm("CreateUser", "Admin", FormMethod.Post))
                    {
                        @Html.AntiForgeryToken()

                        <div class="mb-4">
                            <label class="form-label-premium">Tên tài khoản <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text bg-transparent border-secondary text-muted" style="border-right:0;"><i class="bi bi-person"></i></span>
                                @Html.TextBoxFor(m => m.TENTAIKHOAN, new { @class = "form-control form-control-premium", placeholder = "Nhập tên tài khoản...", style = "border-left:0;" })
                            </div>
                            @Html.ValidationMessageFor(m => m.TENTAIKHOAN, "", new { @class = "text-danger small mt-1 fw-bold" })
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label-premium">Mật khẩu <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-transparent border-secondary text-muted" style="border-right:0;"><i class="bi bi-lock"></i></span>
                                    @Html.PasswordFor(m => m.MATKHAU, new { @class = "form-control form-control-premium", id = "password", placeholder = "Nhập mật khẩu...", style = "border-left:0;" })
                                </div>
                                @Html.ValidationMessageFor(m => m.MATKHAU, "", new { @class = "text-danger small mt-1 fw-bold" })
                            </div>
                            <div class="col-md-6 mb-4">
                                <label class="form-label-premium">Xác nhận mật khẩu <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-transparent border-secondary text-muted" style="border-right:0;"><i class="bi bi-check2-all"></i></span>
                                    <input id="passwordConfirm" name="passwordConfirm" type="password" class="form-control form-control-premium" placeholder="Nhập lại mật khẩu..." style = "border-left:0;" />
                                </div>
                                <small id="pwError" class="text-danger fw-bold d-none mt-1"><i class="bi bi-x-circle me-1"></i>Mật khẩu không khớp!</small>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label-premium">Loại tài khoản <span class="text-danger">*</span></label>
                             <div class="input-group">
                                 <span class="input-group-text bg-transparent border-secondary text-muted" style="border-right:0;"><i class="bi bi-shield-lock"></i></span>
                                @Html.DropDownListFor(m => m.LOAITAIKHOAN, roleList, "Chọn loại tài khoản", new { @class = "form-select form-select-premium", id = "roleSelect", style = "border-left:0;" })
                            </div>
                        </div>

                        <div id="khSection" class="mb-4 p-3 rounded border border-secondary border-opacity-25 bg-secondary bg-opacity-10 d-none">
                            <label class="form-label-premium text-info">Liên kết khách hàng</label>
                            @Html.DropDownListFor(m => m.MAKHACHHANG, new SelectList(khList ?? new List<WebBanGIay.Models.KHACHHANG>(), "MAKHACHHANG", "HOTEN", Model?.MAKHACHHANG), "-- chọn khách hàng --", new { @class = "form-select form-select-premium" })
                            @Html.ValidationMessageFor(m => m.MAKHACHHANG, "", new { @class = "text-danger small mt-1" })
                            <div class="form-text text-muted mt-2"><i class="bi bi-info-circle me-1"></i> Tài khoản dành cho khách mua hàng.</div>
                        </div>

                        <div id="nvSection" class="mb-4 p-3 rounded border border-secondary border-opacity-25 bg-secondary bg-opacity-10 d-none">
                            <label class="form-label-premium text-warning">Liên kết nhân viên</label>
                            @Html.DropDownListFor(m => m.MANHANVIEN, new SelectList(nvList ?? new List<WebBanGIay.Models.NHANVIEN>(), "MANHANVIEN", "HOTEN", Model?.MANHANVIEN), "-- chọn nhân viên --", new { @class = "form-select form-select-premium" })
                            @Html.ValidationMessageFor(m => m.MANHANVIEN, "", new { @class = "text-danger small mt-1" })
                            <div class="form-text text-muted mt-2"><i class="bi bi-info-circle me-1"></i> Tài khoản này sẽ có quyền truy cập trang Admin.</div>
                        </div>

                        <div class="d-flex justify-content-end gap-3 mt-5">
                            <a href="@Url.Action("Users", "Admin")" class="btn btn-outline-secondary btn-premium px-4">
                                <i class="bi bi-arrow-left me-1"></i> Hủy
                            </a>
                            <button id="btnSubmit" type="submit" class="btn btn-success btn-premium px-5">
                                <i class="bi bi-check-circle me-1"></i> Tạo tài khoản
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById("btnSubmit").addEventListener("click", function (e) {
        let pw = document.getElementById("password").value;
        let pwc = document.getElementById("passwordConfirm").value;

        if (pw !== pwc) {
            e.preventDefault();
            document.getElementById("pwError").classList.remove("d-none");
        } else {
            document.getElementById("pwError").classList.add("d-none");
        }
    });

    function updateRoleSections() {
        let role = document.getElementById("roleSelect").value;

        document.getElementById("khSection").classList.add("d-none");
        document.getElementById("nvSection").classList.add("d-none");

        if (role === "KHÁCH HÀNG") {
            document.getElementById("khSection").classList.remove("d-none");
        }
        else if (role === "NHÂN VIÊN") {
            document.getElementById("nvSection").classList.remove("d-none");
        }
    }

    // Run once on load
    document.addEventListener("DOMContentLoaded", function() {
        updateRoleSections();
        document.getElementById("roleSelect").addEventListener("change", updateRoleSections);
    });
</script>
