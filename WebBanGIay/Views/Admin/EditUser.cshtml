@model WebBanGIay.Models.TAIKHOAN
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewBag.Title = "Sửa tài khoản";
    var khList = ViewBag.KhachHangList as IEnumerable<WebBanGIay.Models.KHACHHANG>;
    var nvList = ViewBag.NhanVienList as IEnumerable<WebBanGIay.Models.NHANVIEN>;
    
    var roleList = new List<SelectListItem>
    {
        new SelectListItem { Value = "KHÁCH HÀNG", Text = "Khách hàng" },
        new SelectListItem { Value = "NHÂN VIÊN", Text = "Nhân viên" },
        new SelectListItem { Value = "QUẢN TRỊ", Text = "Quản trị" }
    };
}

<style>
    .page-container {
        padding: 24px;
        color: var(--text-main);
    }
</style>

<div class="page-container">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card card-premium shadow-lg">
                <div class="card-header-premium">
                    <h5><i class="bi bi-person-gear text-info"></i> Sửa thông tin tài khoản</h5>
                </div>
                <div class="card-body p-4">
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger mb-4 border-0 bg-danger bg-opacity-10 text-danger fw-bold">
                            <i class="bi bi-exclamation-triangle me-2"></i> @TempData["Error"]
                        </div>
                    }

                    @using (Html.BeginForm("EditUser", "Admin", FormMethod.Post))
                    {
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.MATAIKHOAN)

                        <div class="mb-4">
                            <label class="form-label-premium">Mã tài khoản</label>
                            <input type="text" class="form-control form-control-premium text-muted" value="@Model.MATAIKHOAN.Trim()" disabled />
                        </div>

                        <div class="mb-4">
                            <label class="form-label-premium">Tên đăng nhập <span class="text-danger">*</span></label>
                            @Html.TextBoxFor(m => m.TENTAIKHOAN, new { @class = "form-control form-control-premium", required = "required", placeholder = "Nhập tên đăng nhập..." })
                            @Html.ValidationMessageFor(m => m.TENTAIKHOAN, "", new { @class = "text-danger small mt-1 fw-bold" })
                        </div>

                        <div class="mb-4">
                            <label class="form-label-premium">Mật khẩu mới <small class="text-muted fw-normal fs-6 ms-2">(Để trống nếu không đổi)</small></label>
                            <div class="input-group">
                                <span class="input-group-text bg-transparent border-secondary text-muted" style="border-right:0;"><i class="bi bi-key"></i></span>
                                <input type="password" name="MATKHAU" class="form-control form-control-premium" placeholder="Nhập mật khẩu mới..." style="border-left:0;" />
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label-premium">Vai trò hệ thống</label>
                            @Html.DropDownListFor(m => m.LOAITAIKHOAN, roleList, "Chọn vai trò", new { @class = "form-select form-select-premium", id = "roleSelect" })
                        </div>

                        <div id="khSection" class="mb-4 p-3 rounded border border-secondary border-opacity-25 bg-secondary bg-opacity-10" style="display:none;">
                            <label class="form-label-premium text-info">Liên kết Khách hàng</label>
                            @Html.DropDownListFor(m => m.MAKHACHHANG, new SelectList(khList ?? new List<WebBanGIay.Models.KHACHHANG>(), "MAKHACHHANG", "HOTEN", Model.MAKHACHHANG), "-- Chọn Khách hàng --", new { @class = "form-select form-select-premium" })
                            <div class="form-text text-muted mt-2"><i class="bi bi-info-circle me-1"></i> Tài khoản này sẽ được dùng để khách hàng đăng nhập.</div>
                        </div>

                        <div id="nvSection" class="mb-4 p-3 rounded border border-secondary border-opacity-25 bg-secondary bg-opacity-10" style="display:none;">
                            <label class="form-label-premium text-warning">Liên kết Nhân viên</label>
                            @Html.DropDownListFor(m => m.MANHANVIEN, new SelectList(nvList ?? new List<WebBanGIay.Models.NHANVIEN>(), "MANHANVIEN", "HOTEN", Model.MANHANVIEN), "-- Chọn Nhân viên --", new { @class = "form-select form-select-premium" })
                            <div class="form-text text-muted mt-2"><i class="bi bi-info-circle me-1"></i> Tài khoản này sẽ có quyền truy cập trang quản trị.</div>
                        </div>

                        <div class="d-flex justify-content-end gap-3 mt-5">
                            <a href="@Url.Action("Users")" class="btn btn-outline-secondary btn-premium">Hủy bỏ</a>
                            <button type="submit" class="btn btn-primary btn-premium">
                                <i class="bi bi-check-circle"></i> Lưu thay đổi
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var roleSelect = document.getElementById("roleSelect");
        var khSection = document.getElementById("khSection");
        var nvSection = document.getElementById("nvSection");

        function toggleSections() {
            var val = roleSelect.value;
            if (val === "KHÁCH HÀNG") {
                khSection.style.display = "block";
                nvSection.style.display = "none";
            } else if (val === "NHÂN VIÊN") {
                khSection.style.display = "none";
                nvSection.style.display = "block";
            } else {
                khSection.style.display = "none";
                nvSection.style.display = "none";
            }
        }
        
        roleSelect.addEventListener("change", toggleSections);
        toggleSections(); // Run on load
    });
</script>
