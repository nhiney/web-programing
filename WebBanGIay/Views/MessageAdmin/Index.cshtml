@model IEnumerable<WebBanGIay.Models.LIENHE>
@{
    ViewBag.Title = "Quản lý Tin nhắn";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    int page = ViewBag.Page ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
}

<style>
    /* SHARED ADMIN THEME STYLES */
    .page-container {
        color: var(--text-main);
        padding: 24px;
        font-family: "Inter", sans-serif;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .page-title {
        font-size: 26px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
    }

    /* Table Styles */
    .table-responsive-custom {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
        box-shadow: var(--shadow-card);
    }
    .table-custom { width: 100%; border-collapse: collapse; }
    .table-custom thead { background: var(--bg-hover); }
    .table-custom th {
        padding: 16px 20px;
        text-align: left;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-label);
        border-bottom: 2px solid var(--border-color);
    }
    .table-custom td {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-main);
        vertical-align: middle;
    }
    .table-custom tbody tr { background: var(--bg-card); transition: background 0.2s; }
    .table-custom tbody tr:hover { background: var(--bg-hover); }

    /* Badges */
    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
    .status-new { background: rgba(78, 115, 223, 0.15); color: #4e73df; }
    .status-read { background: rgba(133, 135, 150, 0.15); color: #858796; }

    /* Actions */
    .action-btn {
        width: 36px; height: 36px;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 8px;
        background: var(--bg-body);
        border: 1px solid var(--border-color);
        color: var(--text-muted);
        margin-right: 4px;
        transition: 0.2s;
        text-decoration: none;
        cursor: pointer;
    }
    .action-btn:hover {
        border-color: var(--accent-color); transform: translateY(-2px);
    }
    .btn-create {
        background: var(--accent-color);
        color: #fff;
        padding: 10px 20px;
        font-weight: 600;
        border-radius: 8px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: 0.2s;
        border: none;
    }
    .btn-create:hover { filter: brightness(1.1); color: #fff; }

    .msg-unread-row {
        background-color: rgba(78, 115, 223, 0.05) !important;
    }
    .msg-unread-row td {
        font-weight: 600;
        color: #2e384d;
    }
    
    .avatar-circle {
        width: 40px; height: 40px;
        background: #e2e8f0;
        color: #64748b;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-weight: 700;
        margin-right: 12px;
    }
</style>

<div class="page-container container-fluid">
    <!-- HEADER -->
    <div class="page-header">
        <div>
            <h2 class="page-title"><i class="bi bi-envelope"></i> Quản lý Tin nhắn</h2>
            <p style="margin: 4px 0 0; color: var(--text-muted); font-size: 0.9rem;">Xem và phản hồi tin nhắn từ khách hàng</p>
        </div>
        <!-- Stats or Filter could go here -->
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success d-flex align-items-center mb-4" role="alert" style="background: rgba(28, 200, 138, 0.15); border: 1px solid rgba(28, 200, 138, 0.3); color: #1cc88a;">
            <i class="bi bi-check-circle-fill me-2"></i> @TempData["Success"]
        </div>
    }

    <!-- TABLE -->
    <div class="table-responsive-custom">
        <table class="table-custom">
            <thead>
                <tr>
                    <th class="ps-4">Khách hàng</th>
                    <th>Nội dung</th>
                    <th>Thời gian</th>
                    <th>Trạng thái</th>
                    <th class="text-center">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (Model == null || !Model.Any())
                {
                    <tr><td colspan="5" class="p-5 text-center text-muted">Chưa có tin nhắn nào.</td></tr>
                }
                else
                {
                    foreach (var item in Model)
                    {
                        bool isRead = item.TrangThai ?? false;
                        string rowClass = isRead ? "" : "msg-unread-row";
                        string avatarLetter = string.IsNullOrEmpty(item.HoTen) ? "?" : item.HoTen.Substring(0, 1).ToUpper();

                        <tr class="@rowClass">
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle">@avatarLetter</div>
                                    <div>
                                        <div>@item.HoTen</div>
                                        <small class="text-muted">@item.Email</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div style="max-width: 300px;">
                                    @{
                                        string content = item.NoiDung;
                                        if (content.Length > 60) { content = content.Substring(0, 60) + "..."; }
                                    }
                                    @content
                                </div>
                            </td>
                            <td>
                                <span style="color:var(--text-muted); font-size:0.9rem;">
                                    <i class="bi bi-clock me-1"></i>@string.Format("{0:dd/MM/yyyy HH:mm}", item.NgayGui)
                                </span>
                            </td>
                            <td>
                                @if(isRead) { 
                                    <span class="status-badge status-read"><i class="bi bi-check-all"></i> Đã xem</span> 
                                } else { 
                                    <span class="status-badge status-new"><i class="bi bi-envelope-fill"></i> Mới</span> 
                                }
                            </td>
                            <td class="text-center">
                                <a href="@Url.Action("Details", new { id = item.MaLH })" class="action-btn" title="Xem chi tiết">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <button onclick="openReplyModal(@item.MaLH, '@item.HoTen', `@item.NoiDung`)" class="action-btn" title="Phản hồi" style="color:#1cc88a; border-color:#1cc88a;">
                                    <i class="bi bi-reply-fill"></i>
                                </button>
                                <form action="@Url.Action("Delete", new { id = item.MaLH })" method="post" class="d-inline" onsubmit="return confirm('Xóa tin nhắn này?');">
                                    <button type="submit" class="action-btn" title="Xóa" style="color:#e74a3b; border-color:#e74a3b;">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- PAGING -->
     <div class="mt-4 d-flex justify-content-center">
        @for (int i = 1; i <= totalPages; i++)
        {
            <a href="?page=@i" class="btn btn-sm mx-1 @(i == page ? "btn-primary" : "btn-light border")" style="width:32px; height:32px; border-radius:8px;">@i</a>
        }
    </div>
</div>

<!-- REPLY MODAL (Styled) -->
<div class="modal fade" id="replyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 15px;">
            <form action="@Url.Action("Reply", "MessageAdmin")" method="post">
                <div class="modal-header bg-primary text-white" style="border-radius: 15px 15px 0 0;">
                    <h5 class="modal-title"><i class="bi bi-reply-fill me-2"></i>Phản hồi khách hàng</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" name="id" id="replyId" />
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-uppercase text-muted">Khách hàng</label>
                        <input type="text" class="form-control" id="replyName" readonly style="background:#f8f9fa;" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-uppercase text-muted">Tin nhắn gốc</label>
                        <textarea class="form-control" id="replyOriginal" rows="3" readonly style="background:#f8f9fa; font-style:italic;"></textarea>
                    </div>
                     <div class="mb-3">
                        <label class="form-label fw-bold small text-uppercase text-muted">Nội dung phản hồi</label>
                        <textarea name="phanHoi" class="form-control shadow-sm" rows="5" required placeholder="Nhập câu trả lời..." style="border: 2px solid #e2e8f0;"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary px-4 fw-bold"><i class="bi bi-send me-2"></i>Gửi ngay</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openReplyModal(id, name, content) {
        document.getElementById('replyId').value = id;
        document.getElementById('replyName').value = name;
        document.getElementById('replyOriginal').value = content;
        new bootstrap.Modal(document.getElementById('replyModal')).show();
    }
</script>
