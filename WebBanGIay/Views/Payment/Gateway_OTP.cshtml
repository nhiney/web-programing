@{
    ViewBag.Title = "Xác thực OTP";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card shadow-lg border-0 text-center">
                <div class="card-body p-5">
                    <div class="mb-4">
                        <div class="icon-circle bg-primary bg-opacity-10 text-primary mx-auto mb-3" style="width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            <i class="fas fa-lock"></i>
                        </div>
                        <h4 class="fw-bold">Xác thực OTP</h4>
                    @if (ViewBag.IsSimulationMode == true)
                    {
                        <div class="alert alert-info shadow-sm border-0 mb-4 text-start">
                            <div class="d-flex">
                                <i class="fas fa-flask mt-1 me-2 text-info"></i>
                                <div>
                                    <strong class="d-block mb-1">CHẾ ĐỘ THỬ NGHIỆM (SIMULATION)</strong>
                                    <span class="small">Hệ thống nhận thấy Email chưa được cấu hình tại <code>Web.config</code>.</span>
                                    <hr class="my-2">
                                    <div class="small">
                                         Mã xác thực đã được "giả lập" gửi đến: <b>@ViewBag.TargetEmail</b>
                                         <br>Để tiếp tục, vui lòng dùng mã vừa tạo: <span id="simulated-otp-badge" class="badge bg-primary fs-6 tracking-widest">@ViewBag.SimulatedOTP</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else if (ViewBag.Error != null)
                    {
                        <div class="alert alert-danger shadow-sm border-0 mb-4 text-start">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Lỗi hệ thống:</strong> <span class="small">@ViewBag.Error</span>
                            <hr class="my-2">
                            <div class="small">
                                <i class="fas fa-info-circle me-1"></i> 
                                Vui lòng kiểm tra lại cấu hình <b>Email/Mật khẩu</b> trong tệp <code>Web.config</code>.
                            </div>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-4">
                            Mã xác thực đã được gửi đến:<br>
                            <span class="fw-bold text-dark">@(ViewBag.TargetEmail ?? "Email của bạn")</span>
                        </p>
                    }

                    @using (Html.BeginForm("VerifyOTP", "Payment", FormMethod.Post, new { id = "otpForm" }))
                    {
                        <div class="d-flex justify-content-between gap-2 mb-4 otp-container">
                            <input type="text" name="otp1" class="form-control text-center otp-input" maxlength="1" required autofocus>
                            <input type="text" name="otp2" class="form-control text-center otp-input" maxlength="1" required>
                            <input type="text" name="otp3" class="form-control text-center otp-input" maxlength="1" required>
                            <input type="text" name="otp4" class="form-control text-center otp-input" maxlength="1" required>
                            <input type="text" name="otp5" class="form-control text-center otp-input" maxlength="1" required>
                            <input type="text" name="otp6" class="form-control text-center otp-input" maxlength="1" required>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-3 fw-bold mb-3 rounded-pill shadow-sm">XÁC NHẬN</button>
                    }

                    <div class="text-muted small">
                        Bạn chưa nhận được mã? <a href="javascript:void(0)" class="text-decoration-none fw-bold" id="resend-link">Gửi lại (30s)</a>
                        <div id="resend-status" class="mt-2 small"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .otp-input {
        width: 100%;
        height: 60px;
        font-size: 1.8rem;
        font-weight: bold;
        border-radius: 12px;
        background: #f8f9fa;
        border: 2px solid #e9ecef;
    }
    .otp-input:focus {
        border-color: #0d6efd;
        background: #fff;
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.15);
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const inputs = document.querySelectorAll(".otp-input");
        
        inputs.forEach((input, index) => {
            input.addEventListener("input", (e) => {
                if (e.target.value.length === 1 && index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            });

            input.addEventListener("keydown", (e) => {
                if (e.key === "Backspace" && e.target.value === "" && index > 0) {
                    inputs[index - 1].focus();
                }
            });
        });

        // Prevent double submission
        const otpForm = document.getElementById('otpForm');
        otpForm.addEventListener("submit", () => {
             const btn = otpForm.querySelector('button[type="submit"]');
             btn.disabled = true;
             btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Đang xử lý...';
        });

        // Timer and Resend Logic
        let timeLeft = 30;
        const resendLink = document.getElementById('resend-link');
        const resendStatus = document.getElementById('resend-status');

        function startTimer() {
            const timer = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    resendLink.innerText = "Gửi lại ngay";
                    resendLink.style.pointerEvents = "auto";
                    resendLink.style.opacity = "1";
                } else {
                    resendLink.innerText = `Gửi lại (${timeLeft}s)`;
                    resendLink.style.pointerEvents = "none";
                    resendLink.style.opacity = "0.5";
                    timeLeft--;
                }
            }, 1000);
        }

        startTimer();

        resendLink.addEventListener("click", () => {
            resendStatus.innerHTML = '<span class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i> Đang gửi...</span>';
            
            fetch('@Url.Action("ResendOTP", "Payment")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (data.isSimulation) {
                        resendStatus.innerHTML = '<span class="text-info"><i class="fas fa-flask me-1"></i> Đã giả lập gửi mã mới!</span>';
                        // Update the displayed code if the badge exists
                        const badge = document.getElementById('simulated-otp-badge');
                        if (badge && data.newOtp) {
                            badge.innerText = data.newOtp;
                        }
                    } else {
                        resendStatus.innerHTML = '<span class="text-success"><i class="fas fa-check me-1"></i> Mã mới đã được gửi!</span>';
                    }
                    timeLeft = 60; // Wait longer for next resend
                    startTimer();
                } else {
                    resendStatus.innerHTML = `<span class="text-danger"><i class="fas fa-times me-1"></i> ${data.message}</span>`;
                }
            })
            .catch(err => {
                resendStatus.innerHTML = '<span class="text-danger"><i class="fas fa-times me-1"></i> Lỗi kết nối.</span>';
            });
        });
    });
</script>
