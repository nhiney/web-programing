@{
    ViewBag.Title = "Thanh toán Thẻ ngân hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="card-gateway-page py-5">
    <div class="container">
        <!-- Progress Steps -->
        <div class="row justify-content-center mb-5">
            <div class="col-md-8">
                 <div class="payment-steps d-flex justify-content-between position-relative">
                    <div class="step-item completed">
                        <div class="step-icon"><i class="fas fa-shopping-cart"></i></div>
                        <span class="step-label">Giỏ hàng</span>
                    </div>
                    <div class="step-item active">
                        <div class="step-icon"><i class="fas fa-credit-card"></i></div>
                        <span class="step-label">Thanh toán</span>
                    </div>
                    <div class="step-item">
                        <div class="step-icon"><i class="fas fa-shield-alt"></i></div>
                        <span class="step-label">Xác thực</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 justify-content-center">
            <!-- Left Side: Card Visual & Security -->
            <div class="col-lg-5 order-lg-1 order-2">
                <div class="card-preview-container mb-4">
                    <div class="flip-card" id="card-preview">
                        <div class="flip-card-inner">
                            <!-- Card Front -->
                            <div class="flip-card-front card-skin-premium p-4 rounded-4 shadow-lg text-white">
                                <div class="d-flex justify-content-between align-items-start mb-5">
                                    <div class="card-type-logo">
                                        <i class="fab fa-cc-visa fa-3x" id="card-logo-type"></i>
                                    </div>
                                    <img src="https://raw.githubusercontent.com/muhammederdem/credit-card-form/master/src/assets/images/chip.png" alt="Chip" style="height: 40px;">
                                </div>
                                
                                <div class="card-number-display mb-4 h3 font-monospace" id="display-number">
                                    •••• •••• •••• ••••
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-end">
                                    <div class="flex-grow-1">
                                        <div class="text-uppercase opacity-75" style="font-size: 0.7rem;">Chủ thẻ</div>
                                        <div class="fw-bold text-uppercase text-truncate" id="display-name" style="max-width: 200px;">HỌ TÊN CỦA BẠN</div>
                                    </div>
                                    <div>
                                        <div class="text-uppercase opacity-75" style="font-size: 0.7rem;">Hết hạn</div>
                                        <div class="fw-bold" id="display-expiry">MM/YY</div>
                                    </div>
                                </div>
                                
                                <div class="glass-overlay"></div>
                            </div>
                            
                            <!-- Card Back -->
                            <div class="flip-card-back card-skin-premium rounded-4 shadow-lg text-white">
                                <div class="black-strip mt-4"></div>
                                <div class="p-4">
                                    <div class="text-end opacity-75 small mb-1">CVV</div>
                                    <div class="cvv-strip bg-white text-dark p-2 rounded-1 text-end fw-bold font-monospace" id="display-cvv">
                                        •••
                                    </div>
                                    <div class="mt-4 opacity-50 small" style="font-size: 0.6rem;">
                                        Thẻ này là tài sản của ngân hàng phát hành. Việc sử dụng thẻ tuân theo các điều khoản và điều kiện của ngân hàng.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="security-badges d-flex flex-wrap justify-content-center gap-3 mt-4">
                    <div class="badge-item"><i class="fas fa-lock text-success"></i> SSL 256-bit</div>
                    <div class="badge-item"><i class="fas fa-check-shield text-primary"></i> PCI DSS Compliant</div>
                    <div class="badge-item"><i class="fas fa-user-shield text-info"></i> 3D Secure</div>
                </div>
                
                <div class="text-center mt-4 opacity-75">
                    <img src="https://cdn-icons-png.flaticon.com/512/179/179457.png" height="30" class="me-2 grayscale" title="Visa">
                    <img src="https://cdn-icons-png.flaticon.com/512/179/179431.png" height="30" class="me-2 grayscale" title="Mastercard">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRz-q-uG2k8WJ_hYkIeI6B0wS6Y_k0zMvL_oA&s" height="20" class="me-2 grayscale" title="Napas">
                </div>
            </div>

            <!-- Right Side: Input Form -->
            <div class="col-lg-5 order-lg-2 order-1">
                <div class="card border-0 shadow-sm rounded-4 p-4 p-md-5 bg-white">
                    <h4 class="fw-bold mb-4 text-dark"><i class="fas fa-wallet text-primary me-2"></i>Thông tin thẻ</h4>

                    @using (Html.BeginForm("ProcessCard", "Payment", FormMethod.Post, new { @id = "card-form" }))
                    {
                        @Html.AntiForgeryToken()
                        
                        <div class="form-floating mb-4">
                            <input type="text" class="form-control premium-input" id="cardNumber" name="cardNumber" placeholder="xxxx xxxx xxxx xxxx" maxlength="19" required autocomplete="cc-number">
                            <label for="cardNumber">Số thẻ</label>
                            <div class="input-icon-right"><i class="far fa-credit-card"></i></div>
                        </div>

                        <div class="form-floating mb-4">
                            <input type="text" class="form-control premium-input text-uppercase" id="cardHolder" name="holder" placeholder="NGUYEN VAN A" required autocomplete="cc-name">
                            <label for="cardHolder">Tên in trên thẻ</label>
                            <div class="input-icon-right"><i class="far fa-user"></i></div>
                        </div>

                        <div class="row g-3">
                            <div class="col-7">
                                <div class="form-floating mb-4">
                                    <input type="text" class="form-control premium-input" id="expiry" name="expiry" placeholder="MM/YY" maxlength="5" required autocomplete="cc-exp">
                                    <label for="expiry">Hết hạn (MM/YY)</label>
                                    <div class="input-icon-right"><i class="far fa-calendar"></i></div>
                                </div>
                            </div>
                            <div class="col-5">
                                <div class="form-floating mb-4">
                                    <input type="password" class="form-control premium-input" id="cvv" name="cvv" placeholder="***" maxlength="3" required autocomplete="cc-csc">
                                    <label for="cvv">CVV</label>
                                    <div class="input-icon-right"><i class="fas fa-shield-alt"></i></div>
                                </div>
                            </div>
                        </div>

                        <div class="amount-summary p-3 rounded-3 bg-light mb-4 border-start border-4 border-primary">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted small">Tổng thanh toán:</span>
                                <span class="h4 mb-0 fw-bold text-primary">@string.Format("{0:N0}", ViewBag.TongTien) đ</span>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm hover-up transition-base">
                            <i class="fas fa-lock me-2"></i>THANH TOÁN AN TOÀN
                        </button>
                    }
                    
                    <div class="text-center mt-4">
                        <a href="@Url.Action("Index")" class="text-muted text-decoration-none small hover-primary transition-base">
                            <i class="fas fa-chevron-left me-1"></i> Thay đổi phương thức thanh toán
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        --card-gold: linear-gradient(135deg, #b8860b 0%, #ffdf00 50%, #b8860b 100%);
        --card-dark: linear-gradient(135deg, #0f172a 0%, #334155 100%);
        --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .card-gateway-page {
        background-color: #f8fafc;
        min-height: 80vh;
    }

    /* Flip Card CSS */
    .card-preview-container {
        perspective: 1000px;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
    }

    .flip-card {
        width: 100%;
        height: 240px;
        transition: transform 0.8s;
        transform-style: preserve-3d;
        cursor: pointer;
    }

    .flip-card.flipped {
        transform: rotateY(180deg);
    }

    .flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.8s;
        transform-style: preserve-3d;
    }

    .flip-card-front, .flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        border-radius: 1.25rem !important;
    }

    .card-skin-premium {
        background: var(--card-dark);
        position: relative;
        overflow: hidden;
    }

    .flip-card-back {
        transform: rotateY(180deg);
        background: #1e293b;
    }

    .glass-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, transparent 60%);
        pointer-events: none;
    }

    .black-strip {
        background: #000;
        height: 45px;
        width: 100%;
    }

    .cvv-strip {
        height: 40px;
        background-image: repeating-linear-gradient(45deg, #eee, #eee 10px, #e5e5e5 10px, #e5e5e5 20px);
    }

    /* Steps UI */
    .payment-steps::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        width: 100%;
        height: 2px;
        background: #e2e8f0;
        z-index: 1;
    }

    .step-item {
        position: relative;
        z-index: 2;
        text-align: center;
        width: 80px;
    }

    .step-icon {
        width: 40px;
        height: 40px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        color: #94a3b8;
        transition: var(--transition);
    }

    .step-item.active .step-icon {
        border-color: #3b82f6;
        color: #3b82f6;
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
    }

    .step-item.completed .step-icon {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    .step-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
    }

    /* Input Styling */
    .premium-input {
        background-color: #f1f5f9 !important;
        border: 1px solid transparent !important;
        font-weight: 600;
        transition: var(--transition);
    }

    .premium-input:focus {
        background-color: #fff !important;
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1) !important;
    }

    .input-icon-right {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 1.1rem;
    }

    .badge-item {
        padding: 6px 14px;
        background: white;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .grayscale { filter: grayscale(1); opacity: 0.6; transition: 0.3s; }
    .grayscale:hover { filter: grayscale(0); opacity: 1; }

    .hover-up:hover { transform: translateY(-2px); }
    .hover-primary:hover { color: #3b82f6 !important; }
    .transition-base { transition: all 0.2s ease-in-out; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const card = document.getElementById('card-preview');
        const numInput = document.getElementById('cardNumber');
        const nameInput = document.getElementById('cardHolder');
        const expInput = document.getElementById('expiry');
        const cvvInput = document.getElementById('cvv');

        const displayNum = document.getElementById('display-number');
        const displayName = document.getElementById('display-name');
        const displayExp = document.getElementById('display-expiry');
        const displayCvv = document.getElementById('display-cvv');
        const cardLogo = document.getElementById('card-logo-type');

        // Card Number Mask & Logo detection
        numInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/\D/g, '');
            let formatted = val.match(/.{1,4}/g)?.join(' ') || '';
            e.target.value = formatted;
            
            displayNum.textContent = formatted || "•••• •••• •••• ••••";

            // Logo detection
            if (val.startsWith('4')) {
                cardLogo.className = 'fab fa-cc-visa fa-3x';
            } else if (val.startsWith('5')) {
                cardLogo.className = 'fab fa-cc-mastercard fa-3x';
            } else {
                cardLogo.className = 'fas fa-credit-card fa-3x';
            }
        });

        // Name
        nameInput.addEventListener('input', function(e) {
            displayName.textContent = e.target.value.toUpperCase() || "HỌ TÊN CỦA BẠN";
        });

        // Expiry
        expInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length >= 2) {
                val = val.substring(0, 2) + '/' + val.substring(2, 4);
            }
            e.target.value = val;
            displayExp.textContent = val || "MM/YY";
        });

        // CVV & Flip
        cvvInput.addEventListener('focus', () => card.classList.add('flipped'));
        cvvInput.addEventListener('blur', () => card.classList.remove('flipped'));
        cvvInput.addEventListener('input', function(e) {
            displayCvv.textContent = e.target.value || "•••";
        });

        // Form Submission Effect
        document.getElementById('card-form').addEventListener('submit', function() {
            const btn = this.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Đang mã hóa dữ liệu...';
        });
    });
</script>
